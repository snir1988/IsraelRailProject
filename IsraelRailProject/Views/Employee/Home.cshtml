@using IsraelRailProject.app.v1.models.dtos
@model IEnumerable<WorkFormForSignDto>

@{
    ViewBag.Title = "איזור עובד - הטפסים שלי";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var cu = Session["CurrentUser"] as CurrentUserDto;
    string userName = ViewBag.UserName as string ?? (cu?.FullName ?? "עובד");
    int? userId = ViewBag.UserId as int? ?? cu?.Id;
}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" />

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <strong>שלום @userName</strong>
        <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">רענון</button>
    </div>

    <div class="card-body">
        @if (TempData["success"] != null)
        {<div class="alert alert-success">@TempData["success"]</div>}
        @if (TempData["error"] != null)
        {<div class="alert alert-danger">@TempData["error"]</div>}

        <p class="text-muted">
            להלן טפסים שממתינים לחתימה שלך (עובד #@userId).
        </p>

        <table id="MyFormsTbl" class="table table-borderless table-hover w-100">
            <thead>
                <tr>
                    <th style="width:90px">מזהה</th>
                    <th style="width:180px">תאריך/שעה</th>
                    <th>אתר</th>
                    <th>סוג עבודה</th>
                    <th>מנהל</th>
                    <th style="width:180px">פעולות</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var row in (Model ?? Enumerable.Empty<WorkFormForSignDto>()))
                {
                    <tr>
                        <td>@row.Id</td>
                        <td>@row.WorkDateTime.ToString("dd/MM/yyyy HH:mm")</td>
                        <td>@row.Site</td>
                        <td>@row.WorkType</td>
                        <td>@row.ManagerName</td>
                        <td>
                            <div class="btn-group">
                                <!-- צפייה בטופס -->
                                <a class="btn btn-sm btn-outline-primary"
                                   href="@Url.Action("Details","History", new { id = row.Id })">
                                    צפייה
                                </a>

                                <!-- חתימה -->
                                @using (Html.BeginForm("Sign", "Employee", FormMethod.Post, new { @class = "d-inline" }))
                                {
                                    @Html.AntiForgeryToken()
                                    @Html.Hidden("id", row.Id) @* המודל חזק, אין צורך ב-casting *@
                                    <button class="btn btn-sm btn-primary" type="submit">חתום</button>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        @if (!(Model?.Any() ?? false))
        {
            <div class="alert alert-info mt-3">
                אין טפסים שממתינים לחתימה כרגע.
            </div>
        }
    </div>
</div>

@section scripts {
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
    <script>
        $(function () {
            $('#MyFormsTbl').DataTable({
                language: { url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/he.json' },
                order: [[1, 'desc']],
                pageLength: 16,
                lengthMenu: [[16, 32, 64, -1], [16, 32, 64, 'הכל']]
            });
        });
    </script>
}
